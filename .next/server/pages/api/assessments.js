"use strict";(()=>{var e={};e.id=417,e.ids=[417],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,s)=>{Object.defineProperty(s,"l",{enumerable:!0,get:function(){return function e(s,t){return t in s?s[t]:"then"in s&&"function"==typeof s.then?s.then(s=>e(s,t)):"function"==typeof s&&"default"===t?s:void 0}}})},7120:(e,s,t)=>{t.r(s),t.d(s,{config:()=>u,default:()=>d,routeModule:()=>m});var n={};t.r(n),t.d(n,{config:()=>i,default:()=>c});var o=t(1802),a=t(7153),r=t(6249);let l=require("mongodb"),i={api:{responseLimit:!1}};async function c(e,s){let t;try{console.log("Connecting to MongoDB..."),t=await l.MongoClient.connect("mongodb+srv://bangdoll:mongodb10Kmaway@cluster0.otlnkpp.mongodb.net/mna-assessment?retryWrites=true&w=majority&appName=Cluster0"),console.log("Connected to MongoDB");let n=t.db("mna-assessment").collection("assessments");if("POST"===e.method){let t=e.body;console.log("Received assessment data:",t);let o=await n.insertOne(t);console.log("Inserted assessment:",o),s.status(201).json({message:"Assessment saved successfully",id:o.insertedId})}else if("GET"===e.method){console.log("Fetching assessments...");let t=await n.find({}).sort({createdAt:-1}).toArray();if(console.log(`Found ${t.length} assessments`),"true"===e.query.export){if(0===t.length)return s.status(404).json({message:"No assessments found to export",error:"No data available"});console.log("Preparing CSV export...");let e=[];for(let s of(e.push(["姓名","性別","出生日期","總分","營養狀況","評估時間","食慾","體重變化","活動能力","用藥情況","壓傷","餐次","乳製品","蛋白質","蔬果","液體","進食方式","自覺營養狀況","健康比較","上臂圍","小腿圍"].map(e=>`"${e}"`).join(",")),t)){let t=[s.name||"","male"===s.gender?"男":"女",s.dob?new Date(s.dob).toLocaleDateString("zh-TW"):"",s.totalScore||"",s.status||"",s.createdAt?new Date(s.createdAt).toLocaleString("zh-TW"):"",s.answers?.appetite||"",s.answers?.weight_change||"",s.answers?.mobility||"",s.answers?.medication||"",s.answers?.pressure_ulcers||"",s.answers?.meals||"",s.answers?.dairy||"",s.answers?.protein||"",s.answers?.fruits_vegetables||"",s.answers?.fluid||"",s.answers?.feeding_mode||"",s.answers?.self_assessment||"",s.answers?.health_comparison||"",s.answers?.ac||"",s.answers?.cc||""];e.push(t.map(e=>`"${String(e).replace(/"/g,'""')}"`).join(","))}let n=Buffer.from([239,187,191]),o=e.join("\n"),a=Buffer.concat([n,Buffer.from(o,"utf-8")]);return console.log("CSV generated, size:",a.length,"bytes"),console.log("First data row:",e[1]),s.setHeader("Content-Type","text/csv; charset=utf-8"),s.setHeader("Content-Disposition",'attachment; filename="mna-assessment-report.csv"'),s.setHeader("Content-Length",a.length),s.send(a)}s.status(200).json(t)}else s.setHeader("Allow",["POST","GET"]),s.status(405).end(`Method ${e.method} Not Allowed`)}catch(e){console.error("Error in API:",e),s.status(500).json({message:"Error processing request",error:e.message,stack:e.stack})}finally{t&&(await t.close(),console.log("Closed MongoDB connection"))}}let d=(0,r.l)(n,"default"),u=(0,r.l)(n,"config"),m=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/assessments",pathname:"/api/assessments",bundlePath:"",filename:""},userland:n})},7153:(e,s)=>{var t;Object.defineProperty(s,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,s,t)=>{e.exports=t(145)}};var s=require("../../webpack-api-runtime.js");s.C(e);var t=s(s.s=7120);module.exports=t})();